# Svelte 5 Migration Guide - Technical Reference

## Overview

This document describes the technical details of migrating the AI Agent HA frontend from Lit Element to Svelte 5, focusing on Home Assistant integration patterns and common pitfalls.

## Key Technologies

- **Svelte 5** - UI framework with new runes API
- **Vite 7** - Build tool
- **TypeScript** - Type safety
- **Shadow DOM** - Style isolation for HA integration
- **WebSocket** - Real-time communication with HA

---

## 1. Build Configuration

### Critical Settings for Home Assistant

#### `vite.config.ts`
```typescript
export default defineConfig({
  plugins: [
    svelte()
    // CSS config should be in svelte.config.js, not here
  ],
  build: {
    lib: {
      entry: './src/main.ts',
      name: 'AiAgentHaPanel',
      fileName: () => 'ai_agent_ha-panel.js',
      formats: ['es']  // ✓ ES module format required by HA
    },
    minify: false,  // or 'terser' for production
    sourcemap: true,
    cssCodeSplit: false,
    rollupOptions: {
      output: {
        inlineDynamicImports: true,
        manualChunks: undefined
      }
    }
  }
});
```

**Important:**
- ❌ `formats: ['iife']` - Home Assistant cannot load IIFE bundles
- ✅ `formats: ['es']` - ES module format required
- ✅ `cssCodeSplit: false` - Keep all CSS together

#### `svelte.config.js`
```javascript
export default {
  compilerOptions: {
    css: 'external'  // ✓ Generate external CSS for Shadow DOM
  }
};
```

**Important:**
- ❌ `css: 'injected'` - Injects CSS to document head, doesn't work with Shadow DOM
- ✅ `css: 'external'` - Generates separate CSS file that can be injected into Shadow DOM

---

## 2. Web Component Wrapper (main.ts)

### Shadow DOM Setup

```typescript
import appCss from './app.css?inline';
import componentCss from '../ai_agent_ha-panel.css?inline';  // Generated by Vite
import AiAgentPanel from './lib/components/AiAgentPanel.svelte';
import { mount, unmount } from 'svelte';

class AiAgentHAPanel extends HTMLElement {
  private svelteApp?: any;
  private mountPoint?: HTMLDivElement;

  constructor() {
    super();
    
    // Attach Shadow DOM
    const shadowRoot = this.attachShadow({ mode: 'open' });
    
    // Inject global styles
    const appStyle = document.createElement('style');
    appStyle.textContent = appCss;
    shadowRoot.appendChild(appStyle);
    
    // Inject component styles (generated by Vite)
    const componentStyle = document.createElement('style');
    componentStyle.textContent = componentCss;
    shadowRoot.appendChild(componentStyle);
    
    // Create mount point
    this.mountPoint = document.createElement('div');
    this.mountPoint.id = 'svelte-app';
    shadowRoot.appendChild(this.mountPoint);
  }
  
  // ...
}
```

**Key Points:**
- ❌ `this.shadowRoot = this.attachShadow()` - shadowRoot is read-only!
- ✅ `const shadowRoot = this.attachShadow()` - Use local variable
- Must inject **both** app.css and component CSS into Shadow DOM
- Component styles are auto-generated at `ai_agent_ha-panel.css`

### Svelte 5 Mount API

```typescript
private _initializeApp() {
  if (!this._hass) return;
  
  // ✓ Use mount() API from Svelte 5
  this.svelteApp = mount(AiAgentPanel, {
    target: this.mountPoint!,
    props: {
      hass: this._hass,
      narrow: this._narrow,
      panel: this._panel,
    },
  });
}

private _destroyApp() {
  if (this.svelteApp) {
    // ✓ Use unmount() function
    unmount(this.svelteApp);
    this.svelteApp = null;
  }
}
```

**Important:**
- ❌ `new Component({ target, props })` - Old Svelte 4 API
- ✅ `mount(Component, { target, props })` - Svelte 5 API
- ❌ `component.$destroy()` - Old API
- ✅ `unmount(component)` - New API
- ❌ `component.$set()` - Not available in Svelte 5

### Props Update Pattern

```typescript
set hass(hass: HomeAssistant) {
  const isFirstSet = !this._hass;
  this._hass = hass;
  
  if (isFirstSet) {
    this._initializeApp();
  }
  // ✗ Don't update props on every hass change!
  // HA updates hass constantly (every state change)
  // This causes infinite remount loops
}
```

**Why not update props?**
- Home Assistant calls `set hass()` on **every state change** in the system
- Updating/remounting component on every change = infinite loop
- Component should use **WebSocket** for data updates, not hass prop

---

## 3. Svelte 5 Store Patterns

### Store Definition

```typescript
import { writable, derived } from 'svelte/store';

export interface AppStateType {
  hass: HomeAssistant | null;
  messages: Message[];
  isLoading: boolean;
}

const initialState: AppStateType = {
  hass: null,
  messages: [],
  isLoading: false,
};

export const appState = writable<AppStateType>(initialState);

// Derived stores
export const hasMessages = derived(
  appState, 
  $state => $state.messages.length > 0
);
```

### Store Usage in Components

```svelte
<script lang="ts">
  import { appState, hasMessages } from '$lib/stores/appState';
  import { get } from 'svelte/store';

  // ✓ In template: use $ syntax for reactive access
  // ✓ In functions: use get() for one-time read
</script>

<!-- ✓ Reactive: auto-updates when store changes -->
{#if $hasMessages}
  {#each $appState.messages as message}
    <MessageBubble {message} />
  {/each}
{/if}

<script>
  function handleClick() {
    // ✓ Read current value in function
    const currentState = get(appState);
    
    // ✓ Update store
    appState.update(s => ({ 
      ...s, 
      isLoading: true 
    }));
  }
</script>
```

**Critical Rules:**
- ❌ `storeValue.property` - Direct access doesn't work
- ✅ `$storeValue.property` - Reactive access in templates
- ✅ `get(store)` - One-time read in functions
- ❌ `store.property = value` - Direct assignment doesn't work
- ✅ `store.update(s => ({ ...s, property: value }))` - Correct update
- ❌ `store.set({ property: value })` - Overwrites entire state
- ✅ `store.update(s => ({ ...s, property: value }))` - Merges state

### Services Pattern

```typescript
import { get } from 'svelte/store';
import { appState } from '$lib/stores/appState';

export async function sendMessage(hass: HomeAssistant, message: string) {
  // ✓ Read from store
  const currentState = get(appState);
  
  // ✓ Update store
  appState.update(s => ({ ...s, isLoading: true }));
  
  try {
    const result = await hass.callWS({ /* ... */ });
    appState.update(s => ({ ...s, isLoading: false }));
    return result;
  } catch (error) {
    appState.update(s => ({ ...s, isLoading: false, error: error.message }));
  }
}
```

---

## 4. Svelte 5 Component Patterns

### Props with $props() Rune

```svelte
<script lang="ts">
  import type { Message } from '$lib/types';

  // ✓ Destructure props with $props()
  let { message }: { message: Message } = $props();
  
  // ✓ Props are reactive automatically
  // No need for $: reactive statements
</script>
```

### Reactivity with $derived and $effect

```svelte
<script lang="ts">
  import { appState } from '$lib/stores/appState';
  
  let { hass }: { hass: HomeAssistant } = $props();
  
  // ✓ Derived value (replaces $: in Svelte 4)
  const messageCount = $derived($appState.messages.length);
  
  // ✓ Side effect (replaces $: in Svelte 4)
  $effect(() => {
    // Runs when hass changes
    appState.update(s => ({ ...s, hass }));
  });
</script>

<p>Messages: {messageCount}</p>
```

### Component Events

```svelte
<script lang="ts">
  // ✓ Define callback props with functions
  let { onclick }: { onclick: () => void } = $props();
</script>

<button {onclick}>Click me</button>
```

**Important:**
- ❌ `createEventDispatcher()` - Old Svelte 4 API
- ✅ Pass callback functions as props

---

## 5. Common Pitfalls & Solutions

### Problem 1: White Screen (Bundle Not Loading)

**Symptoms:**
- Panel shows white screen
- No console logs
- Bundle exists at `/frontend/ai_agent_ha/ai_agent_ha-panel.js` (200 OK)

**Cause:** Wrong bundle format (IIFE instead of ES module)

**Solution:**
```typescript
// vite.config.ts
build: {
  lib: {
    formats: ['es']  // ✓ Not 'iife'
  }
}
```

### Problem 2: Cannot Set shadowRoot (TypeError)

**Symptoms:**
```
TypeError: Cannot set property shadowRoot of #<Element> which has only a getter
```

**Cause:** Trying to assign to read-only property

**Solution:**
```typescript
// ❌ Wrong
this.shadowRoot = this.attachShadow({ mode: 'open' });

// ✓ Correct
const shadowRoot = this.attachShadow({ mode: 'open' });
```

### Problem 3: RangeError in each.js

**Symptoms:**
```
RangeError: Invalid array length at Array.push
at reconcile (each.js:554:16)
```

**Cause:** Missing or duplicate keys in `{#each}` block

**Solution:**
```svelte
<!-- ❌ Wrong: non-unique keys -->
{#each $appState.messages as message (message.text)}

<!-- ✓ Correct: unique ID -->
{#each $appState.messages as message (message.id)}
```

Ensure every message has unique `id`:
```typescript
const message = {
  id: `${type}-${Date.now()}-${Math.random()}`,
  type: 'user',
  text: userInput
};
```

### Problem 4: Infinite Remount Loop

**Symptoms:**
- Console shows repeated "Remounting with updated props"
- Component flickers/reloads constantly

**Cause:** Remounting component on every hass update

**Solution:**
```typescript
set hass(hass: HomeAssistant) {
  const isFirstSet = !this._hass;
  this._hass = hass;
  
  if (isFirstSet) {
    this._initializeApp();
  }
  // ✓ Don't update after first mount
  // Component uses WebSocket, not hass prop
}
```

### Problem 5: Empty Selectors (No Reactive Updates)

**Symptoms:**
- Data loads successfully (visible in console logs)
- Selectors remain empty
- Store has data but UI doesn't update

**Cause:** Missing `$` syntax for store subscriptions

**Solution:**
```svelte
<!-- ❌ Wrong: no reactivity -->
{#if hasProviders}
  {#each providerState.availableProviders as provider}

<!-- ✓ Correct: reactive -->
{#if $hasProviders}
  {#each $providerState.availableProviders as provider}
```

### Problem 6: CSS Not Loading (Styles Missing)

**Symptoms:**
- UI renders but has no styling
- Everything looks unstyled/plain

**Cause:** CSS injected to document head instead of Shadow DOM

**Solution:**
```javascript
// svelte.config.js
export default {
  compilerOptions: {
    css: 'external'  // ✓ Not 'injected'
  }
};
```

```typescript
// main.ts - inject generated CSS
import componentCss from '../ai_agent_ha-panel.css?inline';

const componentStyle = document.createElement('style');
componentStyle.textContent = componentCss;
shadowRoot.appendChild(componentStyle);
```

---

## 6. Best Practices

### State Management

1. **Use stores for shared state** - Don't pass data through many component levels
2. **Use `get()` in functions** - For one-time reads
3. **Use `$store` in templates** - For reactive rendering
4. **Always merge state** - `store.update(s => ({ ...s, newProp }))`
5. **Never mutate state directly** - Always create new objects

### Component Design

1. **Keep components small** - Single responsibility
2. **Use TypeScript** - Catch errors at compile time
3. **Add unique IDs** - For all items in `{#each}` loops
4. **Handle loading states** - Show loaders/skeletons
5. **Handle errors gracefully** - Display error messages

### Performance

1. **Minimize prop updates** - Don't update on every HA state change
2. **Use derived stores** - For computed values
3. **Lazy load when possible** - Dynamic imports for large features
4. **Debounce user input** - Prevent excessive WebSocket calls

### Home Assistant Integration

1. **Use WebSocket for data** - Not hass prop updates
2. **Handle connection failures** - Reconnect logic
3. **Test in Shadow DOM** - Styles must work in isolation
4. **Use HA color variables** - `var(--primary-color)` etc.
5. **Support mobile view** - Responsive design

---

## 7. File Structure

```
frontend/
├── src/
│   ├── main.ts                 # Web Component wrapper
│   ├── app.css                 # Global styles
│   ├── lib/
│   │   ├── components/         # Svelte components
│   │   │   ├── AiAgentPanel.svelte
│   │   │   ├── Chat/
│   │   │   ├── Input/
│   │   │   └── Sidebar/
│   │   ├── stores/             # Svelte stores
│   │   │   ├── appState.ts
│   │   │   ├── sessions.ts
│   │   │   ├── providers.ts
│   │   │   └── ui.ts
│   │   ├── services/           # Business logic
│   │   │   ├── websocket.service.ts
│   │   │   ├── session.service.ts
│   │   │   └── provider.service.ts
│   │   ├── types/              # TypeScript types
│   │   └── utils/              # Helper functions
│   └── vite-env.d.ts
├── vite.config.ts              # Vite configuration
├── svelte.config.js            # Svelte configuration
├── tsconfig.json               # TypeScript configuration
├── package.json
└── ai_agent_ha-panel.js        # Generated bundle (git ignored)
```

---

## 8. Testing Checklist

Before deploying:

- [ ] Bundle loads (check Network tab)
- [ ] No console errors
- [ ] Custom element registered
- [ ] Shadow DOM created
- [ ] CSS loaded (styles work)
- [ ] Component mounts
- [ ] Stores update reactively
- [ ] WebSocket connects
- [ ] Messages send/receive
- [ ] Selectors populated
- [ ] Mobile view works
- [ ] Error handling works
- [ ] Loading states display

---

## 9. Debugging Tips

### Enable Verbose Logging

Add console.log statements at key points:
- Bundle load
- Component registration
- Mount/unmount
- Store updates
- WebSocket events

### Check Store State

In browser console:
```javascript
// Access store directly (for debugging only)
window.__STORES__ = {
  appState: /* import and expose */
};
```

### Inspect Shadow DOM

```javascript
const panel = document.querySelector('ai-agent-ha-panel');
console.log('Shadow root:', panel?.shadowRoot);
console.log('Children:', panel?.shadowRoot?.childNodes);
```

### Monitor WebSocket

```javascript
// In browser DevTools -> Network -> WS tab
// Watch for 'ai_agent_ha/' message types
```

---

## 10. Migration Summary

### What Changed

| Aspect | Lit Element | Svelte 5 |
|--------|-------------|----------|
| Build | Unbundled ESM | Vite bundler |
| Format | ES module (CDN imports) | ES module (bundled) |
| CSS | Inline in JS | External + injected |
| State | Properties | Stores |
| Reactivity | `@property` | `$store` syntax |
| Component API | `new Component()` | `mount()` |
| Cleanup | `component.$destroy()` | `unmount()` |
| Props | `component.prop = value` | Pass to mount() |

### Key Improvements

- ✅ Better type safety with TypeScript
- ✅ More maintainable code structure
- ✅ Better developer experience
- ✅ Smaller bundle size (with minification)
- ✅ Better performance
- ✅ Modern reactive patterns

---

## Resources

- [Svelte 5 Documentation](https://svelte.dev/docs/svelte/overview)
- [Svelte 5 Runes](https://svelte.dev/docs/svelte/$state)
- [Vite Documentation](https://vitejs.dev/)
- [Home Assistant Frontend Architecture](https://developers.home-assistant.io/docs/frontend/)
- [Web Components Standard](https://developer.mozilla.org/en-US/docs/Web/Web_Components)

---

## Support

For issues specific to this implementation:
- Check console for error messages
- Verify build output (formats: ['es'])
- Confirm Shadow DOM has styles
- Check store reactivity with $ syntax
- Test WebSocket connection

**Remember:** Most issues come from incorrect store usage (missing `$` syntax) or wrong build configuration (IIFE vs ES module).
